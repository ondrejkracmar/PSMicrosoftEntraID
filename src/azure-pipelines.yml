name: Publish Powershell Module To Private Repository 
trigger:
  - main

parameters:
    company: "i-system"
    project: "AutomationPlatform"
    feedName: "AzArtifactsPSModules"
    userName: "odrej.kracmar@email.cz"
    password: "cmx7uvg7gz7heq6r3fkkh54vcjy5frtobrk5irszfguigsds3juq"

steps:
   - task: PowerShell@2
     displayName: Install Prerequisites For Validation
     inputs:
       targetType: filePath
       filePath: "./src//build/vsts-prerequisites.ps1"

   - task: PowerShell@2
     displayName: Validation/Test Powershell Module
     inputs:
       targetType: filePath
       filePath: "./src/build/vsts-validate.ps1"

   - task: PublishTestResults@2
     displayName: "Publish Test Results **/TEST-*.xml"
     inputs:
       testResultsFormat: NUnit
     condition: always()

   - task: PowerShell@2
     displayName: Build Nuget For Powerhell module
     inputs:
       targetType: filePath
       filePath: "./src/build/vsts-build.ps1"
       arguments: > # Use this to avoid newline characters in multiline string
          -WorkingDirectory "./src"
          -LocalRepo

   - task: PowerShell@2
     displayName: Publish Powershell Module/Nuget To Private Azure Artifact/Powershell Reposityr
     inputs:
        rootDirectory: $(Pipeline.Workspace)
        targetType: inline
        script: |
          $source= "https://pkgs.dev.azure.com/{0}}/{1}}/_packaging/{2}}/nuget/v2" -f ${{ parameters.company }}, ${{ parameters.project }}, ${{ parameters.feedName }}
          nuget source add -Name "AzArtifactsPSModules" -Source $ource -username ${{ parameters.userName }} -password ${{ parameters.password }}
          nuget push -Source "AzArtifactsPSModules" -ApiKey ((New-Guid).Guid)  "PSAzureADDirectory.0.9.9.3.nupkg" -SkipDuplicate